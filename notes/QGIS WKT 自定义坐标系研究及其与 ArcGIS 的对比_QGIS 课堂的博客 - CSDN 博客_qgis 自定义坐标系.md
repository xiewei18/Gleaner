# QGIS WKT 自定义坐标系研究及其与 ArcGIS 的对比_QGIS 课堂的博客 - CSDN 博客_qgis 自定义坐标系
Save From : [QGIS WKT 自定义坐标系研究及其与 ArcGIS 的对比_QGIS 课堂的博客 - CSDN 博客_qgis 自定义坐标系](https://blog.csdn.net/QGISClass/article/details/112344243) 

## Content
我国全国版图常用的投影为双标准纬线圆锥投影，如等积 Albers 投影或者等角 Lambert 投影，所使用的地理坐标参照系则依据数据生产时间而有所不同，如早期的北京 54 坐标系和西安 80 坐标系，以及近年来所普遍采用的国家 2000 大地坐标系。本文以获取自中国科学院资源环境科学与数据中心的 2015 年省级行政区划数据为示范，该数据为 SHP 格式，采用的就是基于北京 54 坐标系的 Albers 投影。

这种双标准纬线、根据制图区域选定中央经线、地理坐标系、投影方式的组合，在大多数 GIS 软件的预定义坐标系中普遍不存在，需要自行定义坐标系，否则该图层将被标记为未识别坐标系的数据，在使用过程中经常出现计算错误或者无法与其他来源的图层叠加显示等问题。

![](https://img-blog.csdnimg.cn/img_convert/3aaa1a1497a7a31cc62cc3444f910c75.png)

QGIS 的自定义投影功能位于菜单【设置】->【自定义投影】下，点击后弹出自定义坐标参照系对话框：

 ![](https://img-blog.csdnimg.cn/img_convert/77f17763bde8781f7f153990704a49e3.png)

点击右上角的![](https://img-blog.csdnimg.cn/img_convert/21b2e5890b33b4bb7a1a0d6abb3b8a4d.png)
按钮添加一个新的自定义坐标系，在名称文本框中为自定义坐标系起一个名字，选择坐标系的描述格式（WKT 或者 Proj），在参数框中给定坐标系参数，即可完成自定义坐标系的创建。

QGIS 自定义坐标系支持 WKT 和 Proj 两种描述格式，由于 Proj 过于简洁，是一种有损描述，因此 QGIS 官方建议使用 WKT 语言来描述坐标系定义。

**熟知文本（Well-known text ，简称 WKT）** 是由开放地理空间联盟（OGC）制订的一种文本标记语言，用便于人们阅读的简洁语法表达地理空间中的几何对象。这种以文字表达几何图形的方式因其方便人们理解、具有很高的可读性、易于存储和易于共享等优势而深受欢迎，进而广泛应用到坐标系定义、坐标变换参数描述等方面。

本文所使用的术语 “**WKT 坐标系定义**”，特指以 WKT 标记语言描述的坐标系定义字符串，若无特殊说明，本文中的 “WKT 坐标系定义” 一词都是此含义。

但是，由上图可以看到，QGIS 的自定义坐标系界面做得比较简陋，操作体验不太友好。

自定义坐标系本身就是一个复杂的过程，需要设置的参数包括椭球体、基准面、投影方式、标准纬线、中央经线等。商用 GIS 软件通常将这个过程分解为易于使用的几个操作步骤向导，用户只需要点击和输入对应的参数即可。例如，ArcMap 10.2 自定义坐标系过程如下：

 ![](https://img-blog.csdnimg.cn/img_convert/7e06b114804ea92ff3a77223814d01de.png)

对普通用户来说，相比手动输入代码的方式，操作向导界面能极大提高用户体验。因为无论使用 WKT 格式还是 Proj 格式，构造一个新的坐标系定义，都需要了解其中的语法结构、关键字和取值。这些对于不了解相关语言规范又想用 QGIS 快速作图的人来说几乎无从下手。

问题最后集中在如何获取 WKT 坐标系定义描述字符串，除了希望随着 QGIS 版本更新，开发团队提供更加友好的操作方式进行自定义坐标系之外，本文通过对比 QGIS 与 ArcGIS WKT 坐标系定义的异同，得出通过导入 ArcGIS PRJ 文件中的 WKT 坐标系定义字符串，解决当前状况下 QGIS 自定义坐标系操作中 WKT 坐标系定义字符串难以构造的问题。

**01  将 ArcGIS  WKT 坐标系定义导入 QGIS**
==================================

如果一个图层的坐标系在 ArcGIS 中进行了正确定义，其 SHP 文件同名的.PRJ 文件即为符合 WKT 语言规范的坐标系定义文本文件。可以用文本编辑器打开并查看其内容，例如 2015 年行政区划数据，其.PRJ 文件的内容为：

![](https://img-blog.csdnimg.cn/img_convert/7e6b273c14e3d7197277c645a6a23dd2.png)

这个 WKT 坐标系定义是否与 QGIS 的 WKT 坐标系定义兼容？如果兼容，则可用它作为 QGIS 自定义投影的坐标系 WKT 参数。为了节约大家阅读时间，我先把结论放在这里：**QGIS 兼容 ArcGIS 的 WKT 坐标系定义字符串，可以直接复制.PRJ 文件的内容作为 QGIS 新坐标系的 WKT 参数。** 

具体操作步骤如下：

点击菜单【设置】->【自定义投影】，打开自定义坐标系对话框，导入过程如下图：

 ![](https://img-blog.csdnimg.cn/img_convert/a8df4424b17a9cc180478136edab0fe8.png)

返回地图主窗口，单击右下角的坐标系区域，弹出坐标系选择对话框，在用户自定义区域找到刚刚新建的坐标系，点击【OK】，QGIS 就可以识别该坐标系了。

![](https://img-blog.csdnimg.cn/img_convert/a77890e2b216309bcd85de1b14a611cd.png)

接下来，我们看看为什么 QGIS 能够兼容 ArcGIS 的 WKT 坐标系定义字符串。要回答这个问题，先从二者的不同之处说起。

**02  QGIS 与 ArcGIS WKT 坐标系定义的差异**
==================================

从 QGIS 的坐标系选择器打开一个投影坐标系，观察两个软件所生成的 WKT 坐标系定义的结构和取值（此处选择示范数据所带 PRJ 导入后生成的自定义坐标系进行比较）：

 ![](https://img-blog.csdnimg.cn/img_convert/fa6a14f97ca716bc9da4acfd16886c34.png)

对比两个字符串，可以看到，虽然都是 WKT 坐标系定义，二者却有很多不同之处，表现在：

**1、关键字不同**
-----------

在 ArcGIS 的 PRJ 文件中，WKT 坐标系定义以 “PROJCS” 开头，表示该坐标系为投影坐标系。与之相对应的 QGIS 投影坐标系使用关键字 “PROJCRS”，后者多了一个字母 “R”。每个投影坐标系均以地理坐标系为基础，在 ArcGIS 中，地理坐标系使用关键字 “GEOGCS”，QGIS 则使用关键字 “BASEGEOGCRS”，详细对比如下表：

![](https://img-blog.csdnimg.cn/img_convert/fc7c8f14312d4052f5c5f41d88b206aa.png)

**2、结构不同**
----------

ArcGIS 的 WKT 坐标系定义中，投影坐标系 “PROJCS” 的属性包括名称、地理坐标系（基准面、椭球体）、中央子午线、投影名称和投影参数、坐标系单位。

QGIS 的 WKT 坐标系定义中，投影坐标系 “PROJCRS” 的属性包括名称、地理坐标系（基准面、椭球体）、中央子午线、投影方式名称、投影方法、投影参数、平面坐标系、适用范围说明，而且在每个数值型参数后面均增加了所使用的单位说明，例如椭球体的半径使用长度单位米，在字符串表现为 “LENGTHUNIT \["metre",1\]”。

**3、名称不同**
----------

WKT 坐标系定义中很多元素带有名称属性，如投影坐标系名称、地理坐标系名称、基准面名称，各个 GIS 厂商对名称的处理方式不同。早期 WKT1 标准中对名称的取值没有明确定义，导致各个厂商的实现方式出现不一致，影响了数据交换，新版标准 WKT2 则要求名称取值以 EPSG 为基准。

总的来说，QGIS 与 ArcGIS 的 WKT 坐标系定义不同，主要是由于依据的 WKT 坐标系定义标准不同引起。

目前 GIS 软件处理 WKT 坐标系定义基于如下标准：

【1】**ISO 19162:2019**，Geographic information — Well-known text representation of coordinate reference systems，WKT 坐标系定义的现行标准，对 ISO 19111:2019 中 WKT 坐标系定义部分做了合并，简称 WKT2。

【2】**ISO 19111:2019**，Geographic information — Referencing by coordinates，Proj 坐标系定义与转换开源项目所依据标准，关于 WKT 坐标系定义部分已合并到 ISO 19162:2019。

【3】**OGC 01-009/ISO 19125-1:2004**，Coordinate Transformation Services，Revision 1.00，2001 年发布，是 OGC 99-049 的升级版本，简称 WKT1。

【4】**OGC 99-049**，Simple Features Specification For SQL，Revision 1.1，WKT 坐标系定义标准第一版。

根据查阅相关资料得知，**ArcGIS 主要依据 WKT1 坐标系定义标准，即 OGC 01-009/ISO 19125-1:2004；QGIS 则符合 WKT2 坐标系定义标准，即 ISO 19162:2019。** 

WKT2 标准在向后兼容方面做出明确规定：要求符合 WKT2 标准的 GIS 软件能够读取和导入 WKT1 坐标系定义，但不要求输出 WKT1 坐标系定义，这也就解释了为什么 QGIS 可以读取和导入 ArcGIS 版本的 WKT 坐标系定义。

**03** **常见 GIS 软件 WKT 坐标系定义所遵循的标准**
====================================

*   **QGIS/GDAL/OGR**，以 WKT 语言为内置坐标系定义描述，导入力图兼容新旧标准以及 ESRI 格式，依据 WKT2（ISO 19162:2019）标准转换和和导出。
    

*   **ESRI**，符合 WKT1（OGC 01-009）标准。
    

*   **PostGIS**，WKT 坐标系定义用 OGR 生成并存储于 spatial\_ref\_sys 表中，因此其遵循的标准与 OGR 相同。
    

*   **FME**，基于 OGR 实现 WKT 坐标系定义的读写操作，与 **QGIS/GDAL/OGR** 一样，力图兼容新老标准和 ESRI 格式的 WKT 坐标系定义。
    

*   **超图 SuperMap 桌面版**，坐标系导出格式为自定义的 XML 文档，尚未支持 WKT 坐标系定义导出。（也可能是我没找到，如果此处与实际不符，请留言指正。）
    

**04  QGIS 和 ArcGIS 对 WKT 坐标系定义的处理机制分析**
========================================

*   **QGIS 对 WKT 坐标系定义的处理机制**
    -------------------------
    

QGIS 对 WKT 坐标系定义的处理分成导入（Import）和导出（Export）两个部分，导入接收 WKT 格式字符串，经过拆分和识别，将其转换为 QGIS 的坐标参照系对象（QgsCoordinateReferenceSystem）；导出则是将 QGIS 的坐标参照系对象转换为符合 WTK2 标准的字符串返回给用户。

**A、****导入处理过程**

从 WKT 坐标系定义字符串到 QGIS 坐标参照系对象的转换主要是由 QgsCoordinateReferenceSystem 类的 createFromWktInternal（）实现，需要传入 WKT 坐标系定义字符串和该字符串对应的描述信息，即我们看到的坐标系名称，流程如下：

1\. 判断 WKT 坐标系定义字符串是否为空，如果为空，则导入失败。

2\. 在缓存查找 WKT 坐标系定义字符串对象。

3\. 如果缓存中找到匹配，将对应的坐标参照系对象赋值给当前坐标参照系实例。

4\. 如果缓存中没有匹配，则判断 WKT 坐标系定义的来源厂商，目前兼容的厂商为：epsg|esri|osgeo|ignf|zangi|iau2000|postgis|internal|user，根据来源厂商分别用对应的标准解析传入的 WKT 坐标系定义字符串，生成坐标参照系对象。

5\. 如果无法匹配来源厂商，则按照一般 WKT 坐标系定义字符串处理。判断当前使用的 Proj 版本，主版本大于等于 6，则使用 Proj4 库查找与传入 WKT 坐标系定义匹配的对象。

6\. 如果 Proj 版本小于 6，则用 ORG 库查找传入的 WKT 坐标系定义。

7\. 如果以上过程没有找到与传入 WKT 坐标系定义匹配的预定义坐标系，则创建新的自定义坐标参照系，存入本地自定义坐标系数据库。

![](https://img-blog.csdnimg.cn/img_convert/cd7c994e712e5e85b392423688fcdbb3.png)

仍以 2015 年省级行政区划数据的坐标系定义导入过程为例，对应的 PRJ 文件 WKT 字符串如下：

```null
PROJCS["Krasovsky_1940_Albers",
```

以该 WKT 坐标系定义作为参数，QGIS 先对该参数做基本的判别（是否为空），然后开始导入过程：

第一步，在缓存中查找该字符串，此处缓存匹配失败。

第二步，判断来源厂商。QGIS 直接用字符串查找来匹配来源厂商，例如，在传入的 WKT 坐标系定义字符串中如果找到字符子串 “ESRI”，则判断该定义来自 ArcGIS，按照 ArcGIS 的标准解析，得到坐标参照系对象。此处没有出现所兼容的厂商标识字符串，所以按照一般 WKT 坐标系定义进行解析。

第三步，如果当前使用的 Proj 版本，主版本大于等于 6，则用 Proj 库将 WKT 坐标系定义转换为 Proj 定义格式，生成坐标参照系对象。当前 Proj 库的最新版本为 7.2，只要经常更新 QGIS，一般 Proj 库的版本均大于等于 6，也就是说，没有标明来源厂商的 WKT 坐标系定义一般由 Proj 库来处理。当 Proj 版本低于 6 时，则用 GDAL/OGR 库来解析传入的 WKT 坐标系定义参数。

无论是 Proj 库还是 GDAL/OGR 库，当前遵循的 WKT 标准均为最新的 WKT2（ISO 19162:2019）。

第四步，如果以上过程没有找到与传入 WKT 坐标系定义匹配的预定义坐标系，则创建新的自定义坐标参照系，存入本地自定义坐标系数据库。

第五步，如果上述过程均不能解析传入的 WKT 坐标系定义，则导入失败，并在消息窗口打印出详细的错误信息。

导入成功后，在坐标系选择对话框的自定义坐标系分组中将看到解析成功后按照 WTK2 标准输出的 WKT 坐标系定义：

```null
PROJCRS["Krasovsky_1940_Albers",
```

由于示范数据所导入的 WKT 坐标系定义无法匹配原有预定义坐标系，因此产生了新的自定义坐标系，所创建自定义坐标系在本地的数据库中也能找到对应的记录。

  
本地数据库的位置一般存储在 C:\\Users\ 用户 \\AppData\\Roaming\\QGIS\\QGIS3\\profiles\\default\\qgis.db，这是一个 SQLite 数据库，打开可以看到一共有四个表：tbl\_bookmarks（存储空间书签）、tbl\_ellipsoid（预定义椭球体）、tbl\_projection（存储投影方法名称、别名等信息）、tbl\_srs（存储用户自定义坐标系），查询 tbl_srs 表可以看到我们自定义的坐标系：

![](https://img-blog.csdnimg.cn/img_convert/13e926fad3140485269d29ce44e30e56.png)

**B、导出处理过程**

导出的流程相对简单，根据需要输出的 WKT 标准版本、是否有换行和缩进空格数三个参数，将坐标参照系的各个属性用关键字和取值的方式组合成符合 WKT 标准的字符串返回给用户。

*   支持导出的 WKT 标准
    

出于兼容性考虑，QGIS 将 WKT 字符串分为 11 种类型：

 ![](https://img-blog.csdnimg.cn/img_convert/907b2b858080861cc9a045325d235b0a.png)

*   **ArcGIS 对 WKT 坐标系定义的处理**
    -------------------------
    

上文已经提过，ArcGIS 的 WKT 输出格式为 WKT1，即符合 OGC 01-009 标准。该标准于 1999 年发布，2001 年修改，存在定义不明确的地方，导致各个 GIS 在实施该标准中出现偏差。

例如：

ESRI WKT 中，节点名称的取值一般用下划线连接，而 GDAL/OGR 的 WKT1 版本用空格分隔。

基准面（DATUM）的名称在 EPSG 名称的基础上增加 “D_” 开头。

PARAMETER 元素的名称不同，例如第一标准纬线在 GDAL/OGR 名称为 “Latitude of 1st standard parallel”，而在 ESRI 中参数名称变为 “standard\_parallel\_1”。另外，GDAL/OGR 的参数名称首字母大写，ESRI 全部用小写字母，实际上根据 OGC 标准，关键字不区分大小写，但是参数取值（引号中的内容）则区分大小写。

单位 UNIT 元素的取值在 GDAL/OGR 中为首字母大写，例如 “Degree”，而 ESRI 则全部小写 “degree”。

……

还有一些未提及的差异，例如对 Lambert 投影，ESRI 将单标准纬线和双标准纬线视为一个投影类型，只是在参数上区分，而 GDAL/OGR 则区分为 2 个投影：LCC 1SP 和 LCC 2SP。

Melita Kennedy 是负责开发 ESRI 地图投影和基准面模块的主要成员，也是 CRS WKT 2.0 标准起草委员会成员之一，根据她在多种场合对 ESRI WKT 处理方式的说明，可以大致得到 ArcGIS 对 WKT 处理：

WKT1 标准的定义本身就存在许多不明确的地方，因此阻碍了 WTK 坐标系的共享；她希望能改进 WKT 的实现方式，也确实在 ArcGIS 10.5.1 和 ArcGIS pro 2.0 完成了对 WKT2 的支持，但是后面备注写道：仅在 GeoPackage 中实现。

ESRI WKT 在对象名称和某些参数的取值虽然增加了下划线以方便阅读，但是在字符串比较中（如参数、名称字符串）则是忽略下划线和前缀字符串 “GCSE_” 和 “D_”，且不区分大小写。

为了兼容其他厂商的 WKT 坐标系，ESRI 维护了一个名称与别名的对照列表，但是没有公开该列表。

**05 小结**
=========

就自定义坐标系而言，QGIS 在兼容性和开放性上做得非常优秀，这也是后来者的优势：在成熟的标准上开发代码，自然会避免前辈们踩过的坑。但是，在进行自定义坐标系操作的用户体验方面，QGIS 与商用 GIS 软件相比还有一定差距。

ArcGIS 作为世界 GIS 行业的领先者，拥有庞大的用户群体，生产并管理着海量的 GIS 数据。很多时候，ArcGIS 对一些问题的处理方式即为 GIS 行业的事实标准，其他 GIS 软件在兼容性方面普遍需要考虑对 ArcGIS 的兼容，这种状况应该还会持续一段时间。与此同时，随着 OGC 等机构主导的开放标准日趋完善，对最新开放标准的支持将成为所有 GIS 软件的必修课，这也意味着 GIS 行业必将走向更加开放和标准的未来。
## Note